<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç›¸å†Œ - ThreeWeb</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            padding: 15px;
        }
        
        .album-selector {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .album-selector h2 {
            margin-bottom: 10px;
            color: #fff;
            font-size: 18px;
            display: block;
        }
        
        #album-dropdown {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #222;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            display: block;
            margin: 10px auto 0;
            transition: all 0.3s;
        }
        
        #album-dropdown:hover {
            border-color: #3498db;
            background-color: #2a2a2a;
        }
        
        #album-dropdown:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .gallery-container {
            width: 100%;
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }
        
        .gallery-header {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .gallery-header h2 {
            font-size: 20px;
            color: #ddd;
        }
        
        .gallery-stats {
            color: #bbb;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .image-slider {
            position: relative;
            overflow: hidden;
            height: 500px;
            cursor: grab;
        }
        
        .image-slider:active {
            cursor: grabbing;
        }
        
        .slider-track {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .slide {
            flex: 0 0 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
        }
        
        .slide-loading img {
            opacity: 0;
        }
        
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #3498db;
            display: none;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .slide-loading .loading-indicator {
            display: block;
        }
        
        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(52, 58, 64, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
            transition: all 0.3s;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            margin: 0;
        }
        
        .nav-btn:hover {
            background-color: rgba(52, 58, 64, 1);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
        }
        
        .nav-btn:active {
            transform: scale(0.95);
        }
        
        .controls-container {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            width: auto;
            margin-left: auto;
            margin-right: auto;
        }
        
        .pagination {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }
        
        .nav-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
        }
        
        #prev-btn {
            margin-right: 5px;
        }
        
        #next-btn {
            margin-left: 5px;
        }
        
        .image-caption-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .image-caption {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
        
        /* ç§»é™¤æ—§çš„åˆ†é¡µå®¹å™¨æ ·å¼ï¼Œç°åœ¨ä½¿ç”¨controls-container */
        
        .pagination {
            display: inline-flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            margin: 0 auto;
        }
        
        .pagination-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .pagination-dot:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .pagination-dot.active {
            background-color: #fff;
            border-color: #3498db;
            transform: scale(1.4);
        }
        
        /* ç§»é™¤æ—§çš„å›¾ç‰‡æ ‡é¢˜æ ·å¼ï¼Œç°åœ¨ä½¿ç”¨æ–°çš„æ ·å¼å®¹å™¨ */
        
        .no-images {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            color: #bbb;
            text-align: center;
            background-color: #111;
            border-radius: 8px;
        }
        
        .no-images i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
        }
        
        .no-images p {
            font-size: 18px;
        }
        
        .back-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: rgba(52, 58, 64, 0.9);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .back-link:hover {
            background-color: rgba(52, 58, 64, 1);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .back-link-container {
            text-align: center;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .gallery-container {
                min-height: 500px;
            }
            
            .image-slider {
                height: 400px;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .navigation {
                padding: 0 10px;
            }
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
</head>
<body>
    <div class="container">
        
        <div class="album-selector">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <h2>ğŸ“‚ é€‰æ‹©ç›¸å†Œ</h2>
                <a href="/" class="back-link">
                    <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
                </a>
            </div>
            <select id="album-dropdown" onchange="handleAlbumChange()" style="width: 100%; font-size: 18px; font-weight: bold;">
                <option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªç›¸å†Œ --</option>
                {% for album in albums %}
                    <option value="{{ album }}">{{ album }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="gallery-container">
            <div class="gallery-header" style="display: flex; align-items: center; gap: 10px;">
                <h2 id="current-album-name">è¯·é€‰æ‹©ä¸€ä¸ªç›¸å†Œ</h2>
                <div class="gallery-stats" id="gallery-stats"></div>
            </div>
            
            <!-- æ–‡ä»¶åæ˜¾ç¤ºåŒºåŸŸ - å®Œå…¨ç§»å‡ºå›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="image-caption-container" style="display: none;">
                <div class="image-caption" id="current-image-caption"></div>
            </div>
            
            <div id="no-images-message" class="no-images">
                <i class="fas fa-images"></i>
                <p>è¯·ä»ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªç›¸å†Œå¼€å§‹æµè§ˆ</p>
            </div>
            
            <div id="image-gallery" style="display: none;">
                <div class="image-slider" id="image-slider">
                    <div class="slider-track" id="slider-track">
                        <!-- å›¾ç‰‡å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
                    </div>
                    
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
                
                <!-- å¯¼èˆªæŒ‰é’®å’Œåˆ†é¡µåŸç‚¹æ˜¾ç¤ºåŒºåŸŸ - åœ¨åŒä¸€è¡Œä¸”é€‚å½“é—´è· -->
                <div style="text-align: center; margin-top: 15px;">
                    <div style="display: inline-flex; align-items: center; gap: 0;">
                        <button class="nav-btn" id="prev-btn" style="margin: 0; width: 40px; height: 40px; font-size: 20px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="pagination" id="pagination" style="display: inline-flex; gap: 10px; margin: 0; padding: 0;"></div>
                        
                        <button class="nav-btn" id="next-btn" style="margin: 0; width: 40px; height: 40px; font-size: 20px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 10px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentAlbum = null;
        let currentImageIndex = 0;
        let images = [];
        let startX = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let isDragging = false;
        let animationID = 0;
        // åŒå‡»æ£€æµ‹å˜é‡
        let lastTapTime = 0;
        let lastTapTarget = null;
        
        // DOMå…ƒç´ 
        const albumDropdown = document.getElementById('album-dropdown');
        const currentAlbumName = document.getElementById('current-album-name');
        const galleryStats = document.getElementById('gallery-stats');
        const noImagesMessage = document.getElementById('no-images-message');
        const imageGallery = document.getElementById('image-gallery');
        const sliderTrack = document.getElementById('slider-track');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const pagination = document.getElementById('pagination');
        const imageSlider = document.getElementById('image-slider');
        const imageCaptionContainer = document.querySelector('.image-caption-container');
        const currentImageCaption = document.getElementById('current-image-caption');
        
        // å…¨å±é¢„è§ˆç›¸å…³å…ƒç´ 
        let fullscreenViewer;
        let fullscreenSlider;
        let fullscreenSliderTrack;
        let fullscreenCloseBtn;
        let fullscreenCurrentIndex = 0;
        let fullscreenStartX = 0;
        let fullscreenStartY = 0;
        let fullscreenCurrentTranslate = 0;
        let fullscreenPrevTranslate = 0;
        let fullscreenIsDragging = false;
        let fullscreenAnimationID = 0;
        let isPinching = false;
        
        // ç¼©æ”¾ç›¸å…³å˜é‡
        let scale = 1;
        let lastDistance = null;
        let lastScale = 1;
        let translateX = 0;
        let translateY = 0;
        let startTranslateX = 0;
        let startTranslateY = 0;
        
        // äº‹ä»¶ç›‘å¬
        albumDropdown.addEventListener('change', handleAlbumChange);
        prevBtn.addEventListener('click', goToPrevSlide);
        nextBtn.addEventListener('click', goToNextSlide);
        
        // è§¦æ‘¸å’Œæ‹–æ‹½äº‹ä»¶
        imageSlider.addEventListener('touchstart', touchStart);
        imageSlider.addEventListener('touchend', touchEnd);
        imageSlider.addEventListener('touchmove', touchMove);
        imageSlider.addEventListener('mousedown', touchStart);
        imageSlider.addEventListener('mouseup', touchEnd);
        imageSlider.addEventListener('mouseleave', touchEnd);
        imageSlider.addEventListener('mousemove', touchMove);
        // æ·»åŠ å…¨å±€é¼ æ ‡é‡Šæ”¾äº‹ä»¶ï¼Œç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½é‡ç½®æ‹–åŠ¨çŠ¶æ€
        document.addEventListener('mouseup', function(e) {
            if (isDragging && e.target === imageSlider) {
                touchEnd();
            }
        });
        
        // é”®ç›˜å¯¼èˆª
        document.addEventListener('keydown', handleKeydown);
        
        // å¤„ç†ç›¸å†Œé€‰æ‹©å˜åŒ–
        function handleAlbumChange() {
            const albumName = albumDropdown.value;
            if (!albumName) return;
            
            loadAlbum(albumName);
        }
        
        // åŠ è½½ç›¸å†Œ
        async function loadAlbum(albumName) {
            try {
                const response = await fetch(`/api/album/${encodeURIComponent(albumName)}`);
                if (!response.ok) {
                    throw new Error('åŠ è½½ç›¸å†Œå¤±è´¥');
                }
                
                const data = await response.json();
                currentAlbum = data.album_name;
                images = data.images;
                currentImageIndex = 0;
                
                updateGalleryUI();
            } catch (error) {
                console.error('åŠ è½½ç›¸å†Œæ—¶å‡ºé”™:', error);
                alert('åŠ è½½ç›¸å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // æ›´æ–°ç›¸å†ŒUI
        function updateGalleryUI() {
            // æ›´æ–°æ ‡é¢˜å’Œç»Ÿè®¡ä¿¡æ¯
            currentAlbumName.textContent = currentAlbum;
            galleryStats.textContent = images.length > 0 ? `å…± ${images.length} å¼ å›¾ç‰‡` : 'æš‚æ— å›¾ç‰‡';
            
            // æ˜¾ç¤ºæˆ–éšè—ç›¸åº”å…ƒç´ 
            if (images.length > 0) {
                noImagesMessage.style.display = 'none';
                imageGallery.style.display = 'block';
                imageCaptionContainer.style.display = 'block';
                renderSlides();
                renderPagination();
                updateSlidePosition();
                updatePagination();
                updateImageCaption();
            } else {
                noImagesMessage.style.display = 'flex';
                imageGallery.style.display = 'none';
                imageCaptionContainer.style.display = 'none';
            }
        }
        
        // æ¸²æŸ“å¹»ç¯ç‰‡
        function renderSlides() {
            sliderTrack.innerHTML = '';
            
            images.forEach((image, index) => {
                const slide = document.createElement('div');
                slide.classList.add('slide');
                slide.dataset.index = index;
                
                const img = document.createElement('img');
                img.src = image.path;
                img.alt = image.name;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰åŒå‡»æ£€æµ‹
                img.addEventListener('click', function() {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTapTime;
                    
                    // æ£€æµ‹æ˜¯å¦ä¸ºåŒå‡»ï¼šæ—¶é—´é—´éš”å°äº300msä¸”æ˜¯åŒä¸€ç›®æ ‡
                    if (tapLength < 300 && tapLength > 0 && lastTapTarget === this) {
                        openFullscreenViewer(index);
                        // é‡ç½®åŒå‡»çŠ¶æ€
                        lastTapTime = 0;
                        lastTapTarget = null;
                    } else {
                        // è®°å½•å•å‡»ä¿¡æ¯
                        lastTapTime = currentTime;
                        lastTapTarget = this;
                        
                        // è®¾ç½®300msåæ¸…é™¤ï¼Œé¿å…è¿ç»­ç‚¹å‡»è¢«è¯¯åˆ¤
                        setTimeout(() => {
                            lastTapTarget = null;
                        }, 300);
                    }
                });
                
                // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.classList.add('loading-indicator');
                loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i><div style="margin-top: 10px; font-size: 14px; color: #bbb;">åŠ è½½ä¸­...</div>';
                
                // å›¾ç‰‡åŠ è½½å¤„ç†
                slide.classList.add('slide-loading');
                img.onload = () => {
                    slide.classList.remove('slide-loading');
                };
                
                slide.appendChild(img);
                slide.appendChild(loadingIndicator);
                sliderTrack.appendChild(slide);
            });
            
            // æ›´æ–°å½“å‰å›¾ç‰‡æ ‡é¢˜
            if (images.length > 0) {
                updateImageCaption();
            }
        }
        
        // æ¸²æŸ“åˆ†é¡µæŒ‡ç¤ºå™¨ - ä¿®æ”¹ä¸º1/næ˜¾ç¤ºå½¢å¼
        function renderPagination() {
            pagination.innerHTML = '';
            
            // åˆ›å»ºé¡µç æ–‡æœ¬å…ƒç´ 
            const pageInfo = document.createElement('div');
            pageInfo.classList.add('page-info');
            pageInfo.style.color = '#fff';
            pageInfo.style.fontSize = '16px';
            pageInfo.style.fontWeight = 'bold';
            pageInfo.style.minWidth = '60px';
            pageInfo.style.textAlign = 'center';
            
            pagination.appendChild(pageInfo);
        }
        
        // æ›´æ–°åˆ†é¡µæŒ‡ç¤ºå™¨
        function updatePagination() {
            const pageInfo = pagination.querySelector('.page-info');
            if (pageInfo && images.length > 0) {
                // æ˜¾ç¤º 1/n æ ¼å¼ï¼Œå½“å‰é¡µç ä»1å¼€å§‹è®¡æ•°
                pageInfo.textContent = `${currentImageIndex + 1}/${images.length}`;
            }
        }
        
        // æ›´æ–°å›¾ç‰‡æ ‡é¢˜
        function updateImageCaption() {
            if (images.length > 0 && currentImageIndex < images.length) {
                currentImageCaption.textContent = images[currentImageIndex].name;
                imageCaptionContainer.style.display = 'block';
            } else {
                imageCaptionContainer.style.display = 'none';
            }
        }
        
        // æ›´æ–°å¹»ç¯ç‰‡ä½ç½®
        function updateSlidePosition() {
            const slideWidth = -currentImageIndex * 100;
            sliderTrack.style.transform = `translateX(${slideWidth}%)`;
            updatePagination();
        }
        
        // ä¸Šä¸€å¼ 
        function goToPrevSlide() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateSlidePosition();
                updatePagination();
                updateImageCaption();
            }
        }
        
        // ä¸‹ä¸€å¼ 
        function goToNextSlide() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateSlidePosition();
                updatePagination();
                updateImageCaption();
            }
        }
        
        // å…¨å±€å˜é‡ - æ·»åŠ ç§»åŠ¨è·ç¦»è®°å½•
        let totalMoveDistance = 0;
        
        // è§¦æ‘¸/é¼ æ ‡å¼€å§‹
        function touchStart(e) {
            startX = getPositionX(e);
            isDragging = true;
            totalMoveDistance = 0;
            
            // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
            cancelAnimationFrame(animationID);
            
            // å¯¹äºé¼ æ ‡äº‹ä»¶ï¼Œé˜»æ­¢æ–‡æœ¬é€‰æ‹©ç­‰é»˜è®¤è¡Œä¸º
            if (e.type.includes('mouse')) {
                e.preventDefault();
            }
            // æ³¨æ„ï¼šåœ¨touchstartä¸­ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä»¥å…è®¸ç‚¹å‡»äº‹ä»¶æ­£å¸¸è§¦å‘
        }
        
        // è§¦æ‘¸/é¼ æ ‡ç§»åŠ¨
        function touchMove(e) {
            if (!isDragging) return;
            
            const currentPosition = getPositionX(e);
            const diff = currentPosition - startX;
            totalMoveDistance = Math.abs(diff); // è®°å½•ç§»åŠ¨æ€»è·ç¦»
            currentTranslate = prevTranslate + diff;
            
            // åªæœ‰åœ¨æœ‰æ˜æ˜¾ç§»åŠ¨æ—¶æ‰é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé¿å…å¹²æ‰°ç‚¹å‡»äº‹ä»¶
            if (totalMoveDistance > 5) {
                e.preventDefault();
            }
            
            // é™åˆ¶æ‹–åŠ¨èŒƒå›´ï¼Œå¢åŠ ä¸€ç‚¹å¼¹æ€§
            if (currentTranslate > 30) {
                currentTranslate = 30;
            } else if (currentTranslate < -(images.length - 1) * 100 - 30) {
                currentTranslate = -(images.length - 1) * 100 - 30;
            }
            
            setSliderPosition();
        }
        
        // è§¦æ‘¸/é¼ æ ‡ç»“æŸ
        function touchEnd() {
            if (!isDragging) return;
            
            isDragging = false;
            
            // æ ¹æ®æ‹–åŠ¨è·ç¦»å†³å®šæ˜¯åˆ‡æ¢å›¾ç‰‡è¿˜æ˜¯å›åˆ°åŸä½
            const threshold = 20; // å‡å°é˜ˆå€¼ï¼Œè®©ç”¨æˆ·åªéœ€è½»è½»æ»‘åŠ¨
            const minMovement = 5; // æœ€å°ç§»åŠ¨è·ç¦»ï¼Œé¿å…çº¯ç‚¹å‡»è¢«è¯¯åˆ¤ä¸ºæ»‘åŠ¨
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç§»åŠ¨è·ç¦»ï¼Œé¿å…çº¯ç‚¹å‡»è§¦å‘åˆ‡æ¢
            if (totalMoveDistance >= minMovement) {
                // è®¡ç®—ç›¸å¯¹å½“å‰ä½ç½®çš„åç§»ç™¾åˆ†æ¯”
                const relativeTranslate = currentTranslate - prevTranslate;
                
                if (relativeTranslate > threshold && currentImageIndex > 0) {
                    // å‘å³æ‹–åŠ¨è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºä¸Šä¸€å¼ 
                    currentImageIndex--;
                } else if (relativeTranslate < -threshold && currentImageIndex < images.length - 1) {
                    // å‘å·¦æ‹–åŠ¨è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºä¸‹ä¸€å¼ 
                    currentImageIndex++;
                }
            }
            
            // åº”ç”¨æƒ¯æ€§åŠ¨ç”»
            applyInertia();
            
            // ç¡®ä¿ä½ç½®æ­£ç¡®æ›´æ–°
            const targetPosition = -currentImageIndex * 100;
            prevTranslate = targetPosition;
            currentTranslate = targetPosition;
            
            updatePagination();
            updateImageCaption();
        }
        
        // è®¾ç½®æ»‘å—ä½ç½®
        function setSliderPosition() {
            sliderTrack.style.transform = `translateX(${currentTranslate}%)`;
        }
        
        // åº”ç”¨æƒ¯æ€§åŠ¨ç”»
        function applyInertia() {
            const targetPosition = -currentImageIndex * 100;
            const duration = 300; // åŠ¨ç”»æŒç»­æ—¶é—´
            const startTime = performance.now();
            const startPosition = currentTranslate;
            const distance = targetPosition - startPosition;
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
                const easeOut = 1 - Math.pow(1 - progress, 3);
                currentTranslate = startPosition + distance * easeOut;
                
                setSliderPosition();
                
                if (progress < 1) {
                    animationID = requestAnimationFrame(animate);
                } else {
                    currentTranslate = targetPosition;
                    setSliderPosition();
                    prevTranslate = currentTranslate;
                }
            }
            
            animationID = requestAnimationFrame(animate);
        }
        
        // è·å–è§¦æ‘¸/é¼ æ ‡ä½ç½®
        function getPositionX(e) {
            return e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        }
        
        function getPositionY(e) {
            return e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        }
        
        // ä¿å­˜Yè½´èµ·å§‹ä½ç½®å·²åœ¨å…¨å±€å˜é‡ä¸­å£°æ˜
        
        // ä¿®æ”¹getPositionXå‡½æ•°è°ƒç”¨å¤„ï¼ŒåŒæ—¶ä¿å­˜Yè½´ä½ç½®
        const originalTouchStart = fullscreenTouchStart;
        fullscreenTouchStart = function(e) {
            fullscreenStartY = getPositionY(e);
            originalTouchStart(e);
        };
        
        // é”®ç›˜å¯¼èˆª
        function handleKeydown(e) {
            if (images.length === 0) return;
            
            // å¦‚æœå…¨å±é¢„è§ˆæ‰“å¼€ï¼Œåˆ™æ§åˆ¶å…¨å±é¢„è§ˆ
            if (document.fullscreenElement || fullscreenViewer && fullscreenViewer.style.display === 'flex') {
                switch (e.key) {
                    case 'ArrowLeft':
                        fullscreenGoToPrevSlide();
                        break;
                    case 'ArrowRight':
                        fullscreenGoToNextSlide();
                        break;
                    case 'Escape':
                        closeFullscreenViewer();
                        break;
                }
            } else {
                // å¦åˆ™æ§åˆ¶æ™®é€šè§†å›¾
                switch (e.key) {
                    case 'ArrowLeft':
                        goToPrevSlide();
                        break;
                    case 'ArrowRight':
                        goToNextSlide();
                        break;
                }
            }
        }
        
        // ===== å…¨å±é¢„è§ˆåŠŸèƒ½ =====
        function openFullscreenViewer(index) {
            // åˆå§‹åŒ–å…¨å±æŸ¥çœ‹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!fullscreenViewer) {
                createFullscreenViewer();
            }
            
            // è®¾ç½®å½“å‰ç´¢å¼•
            fullscreenCurrentIndex = index;
            fullscreenPrevTranslate = -fullscreenCurrentIndex * 100;
            fullscreenCurrentTranslate = fullscreenPrevTranslate;
            
            // æ¸²æŸ“å…¨å±å¹»ç¯ç‰‡
            renderFullscreenSlides();
            
            // æ˜¾ç¤ºå…¨å±æŸ¥çœ‹å™¨
            fullscreenViewer.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            
            // å°è¯•è¿›å…¥å…¨å±æ¨¡å¼
            if (fullscreenViewer.requestFullscreen) {
                fullscreenViewer.requestFullscreen();
            }
        }
        
        function closeFullscreenViewer() {
            // é€€å‡ºå…¨å±æ¨¡å¼
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
            
            // éšè—å…¨å±æŸ¥çœ‹å™¨
            if (fullscreenViewer) {
                fullscreenViewer.style.display = 'none';
            }
            document.body.style.overflow = 'auto'; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        }
        
        function createFullscreenViewer() {
            // åˆ›å»ºå…¨å±æŸ¥çœ‹å™¨å®¹å™¨
            fullscreenViewer = document.createElement('div');
            fullscreenViewer.id = 'fullscreen-viewer';
            fullscreenViewer.style.cssText = `
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.95);
                z-index: 1000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            `;
            
            // åˆ›å»ºå…³é—­æŒ‰é’®
            fullscreenCloseBtn = document.createElement('button');
            fullscreenCloseBtn.id = 'fullscreen-close-btn';
            fullscreenCloseBtn.innerHTML = '<i class="fas fa-times"></i>';
            fullscreenCloseBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 20px;
                cursor: pointer;
                z-index: 1001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            fullscreenCloseBtn.addEventListener('click', closeFullscreenViewer);
            
            // åˆ›å»ºå…¨å±æ»‘å—å®¹å™¨
            fullscreenSlider = document.createElement('div');
            fullscreenSlider.id = 'fullscreen-slider';
            fullscreenSlider.style.cssText = `
                width: 100%;
                height: 100%;
                overflow: hidden;
                position: relative;
            `;
            
            // åˆ›å»ºå…¨å±æ»‘å—è½¨é“
            fullscreenSliderTrack = document.createElement('div');
            fullscreenSliderTrack.id = 'fullscreen-slider-track';
            fullscreenSliderTrack.style.cssText = `
                display: flex;
                transition: transform 0.3s ease;
                height: 100%;
            `;
            
            // ç»„è£…å…ƒç´ 
            fullscreenSlider.appendChild(fullscreenSliderTrack);
            fullscreenViewer.appendChild(fullscreenCloseBtn);
            fullscreenViewer.appendChild(fullscreenSlider);
            
            // æ·»åŠ åˆ°æ–‡æ¡£
            document.body.appendChild(fullscreenViewer);
            
            // æ·»åŠ è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
            fullscreenSlider.addEventListener('touchstart', fullscreenTouchStart);
            fullscreenSlider.addEventListener('touchend', fullscreenTouchEnd);
            fullscreenSlider.addEventListener('touchmove', fullscreenTouchMove);
            fullscreenSlider.addEventListener('mousedown', fullscreenTouchStart);
            fullscreenSlider.addEventListener('mouseup', fullscreenTouchEnd);
            fullscreenSlider.addEventListener('mouseleave', fullscreenTouchEnd);
            fullscreenSlider.addEventListener('mousemove', fullscreenTouchMove);
            
            // æ·»åŠ å…¨å±€é‡ç½®ç¼©æ”¾äº‹ä»¶
            fullscreenCloseBtn.addEventListener('click', function() {
                // é‡ç½®ç¼©æ”¾å’Œä½ç§»
                resetImageTransforms();
                closeFullscreenViewer();
            });
            
            // æ·»åŠ ç‚¹å‡»åˆ‡æ¢äº‹ä»¶ï¼ˆç‚¹å‡»å·¦å³åŠéƒ¨åˆ†ï¼‰
            fullscreenSlider.addEventListener('click', function(e) {
                if (!fullscreenIsDragging && e.target === fullscreenSlider) {
                    const rect = fullscreenSlider.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const clickX = e.clientX - rect.left;
                    
                    if (clickX < centerX) {
                        fullscreenGoToPrevSlide();
                    } else {
                        fullscreenGoToNextSlide();
                    }
                }
            });
            
            // ç›‘å¬å…¨å±å˜åŒ–äº‹ä»¶
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement && fullscreenViewer && fullscreenViewer.style.display === 'flex') {
                    closeFullscreenViewer();
                }
            });
        }
        
        function renderFullscreenSlides() {
            fullscreenSliderTrack.innerHTML = '';
            
            images.forEach((image, index) => {
                const slide = document.createElement('div');
                slide.classList.add('fullscreen-slide');
                slide.dataset.index = index;
                slide.style.cssText = `
                    min-width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                `;
                
                const img = document.createElement('img');
                img.src = image.path;
                img.alt = image.name;
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    transform-origin: center;
                    transition: transform 0.2s ease;
                    cursor: grab;
                `;
                
                // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ŒåŒå‡»é‡ç½®ç¼©æ”¾
                img.addEventListener('dblclick', function() {
                    resetImageTransform(this);
                });
                
                // æ·»åŠ å›¾ç‰‡æ ‡é¢˜
                const caption = document.createElement('div');
                caption.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    left: 0;
                    right: 0;
                    text-align: center;
                    color: white;
                    font-size: 16px;
                    background-color: rgba(0, 0, 0, 0.7);
                    padding: 10px;
                    margin: 0 20px;
                    border-radius: 5px;
                `;
                caption.textContent = image.name;
                
                slide.appendChild(img);
                slide.appendChild(caption);
                fullscreenSliderTrack.appendChild(slide);
            });
            
            // æ›´æ–°æ»‘å—ä½ç½®
            updateFullscreenSlidePosition();
        }
        
        function updateFullscreenSlidePosition() {
            const slideWidth = -fullscreenCurrentIndex * 100;
            fullscreenSliderTrack.style.transform = `translateX(${slideWidth}%)`;
        }
        
        function fullscreenGoToPrevSlide() {
            if (fullscreenCurrentIndex > 0) {
                fullscreenCurrentIndex--;
                // é‡ç½®å½“å‰å›¾ç‰‡çš„å˜æ¢
                resetImageTransform();
                updateFullscreenSlidePosition();
            }
        }
        
        function fullscreenGoToNextSlide() {
            if (fullscreenCurrentIndex < images.length - 1) {
                fullscreenCurrentIndex++;
                // é‡ç½®å½“å‰å›¾ç‰‡çš„å˜æ¢
                resetImageTransform();
                updateFullscreenSlidePosition();
            }
        }
        
        // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // é‡ç½®å•ä¸ªå›¾ç‰‡çš„å˜æ¢
        function resetImageTransform(img) {
            scale = 1;
            translateX = 0;
            translateY = 0;
            startTranslateX = 0;
            startTranslateY = 0;
            lastDistance = null;
            lastScale = 1;
            isPinching = false;
            
            if (img) {
                img.style.transform = 'scale(1) translate(0, 0)';
            }
        }
        
        // é‡ç½®æ‰€æœ‰å›¾ç‰‡çš„å˜æ¢
        function resetImageTransforms() {
            const slides = fullscreenSliderTrack.querySelectorAll('.fullscreen-slide img');
            slides.forEach(img => {
                resetImageTransform(img);
            });
        }
        
        function fullscreenTouchStart(e) {
            fullscreenStartX = getPositionX(e);
            fullscreenStartY = getPositionY(e);
            fullscreenIsDragging = true;
            isPinching = false;
            
            // ä¿å­˜å½“å‰çš„ä½ç§»çŠ¶æ€
            startTranslateX = translateX;
            startTranslateY = translateY;
            
            // å¤„ç†åŒæŒ‡è§¦æ‘¸å¼€å§‹
            if (e.type === 'touchstart' && e.touches.length === 2) {
                lastDistance = getDistance(e.touches);
                lastScale = scale;
                isPinching = true;
                // åŒæŒ‡æ“ä½œæ—¶ï¼Œä¸è¿›è¡Œå›¾ç‰‡åˆ‡æ¢çš„åˆå§‹åŒ–
            }
            
            // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
            cancelAnimationFrame(fullscreenAnimationID);
            
            // æ³¨æ„ï¼šåœ¨touchstartä¸­ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä»¥å…è®¸ç‚¹å‡»äº‹ä»¶æ­£å¸¸è§¦å‘
            // å¯¹äºé¼ æ ‡äº‹ä»¶ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸º
            if (e.type.includes('mouse')) {
                e.preventDefault();
            }
        }
        
        function fullscreenTouchMove(e) {
            if (!fullscreenIsDragging) return;
            
            // è·å–å½“å‰æ´»åŠ¨çš„å›¾ç‰‡
            const currentSlide = fullscreenSliderTrack.querySelector(`.fullscreen-slide[data-index="${fullscreenCurrentIndex}"]`);
            if (!currentSlide) return;
            
            const currentImg = currentSlide.querySelector('img');
            if (!currentImg) return;
            
            // è®¡ç®—ç§»åŠ¨è·ç¦»
            const currentX = getPositionX(e);
            const currentY = getPositionY(e);
            const diffX = currentX - fullscreenStartX;
            const diffY = currentY - fullscreenStartY;
            
            // åªæœ‰åœ¨æœ‰æ˜æ˜¾ç§»åŠ¨æ—¶æ‰é˜»æ­¢é»˜è®¤è¡Œä¸º
            if (Math.abs(diffX) > 5 || Math.abs(diffY) > 5) {
                e.preventDefault();
            }
            
            // å¤„ç†åŒæŒ‡ç¼©æ”¾ - æ›´é«˜ä¼˜å…ˆçº§
            if (e.type === 'touchmove' && e.touches.length === 2) {
                isPinching = true;
                
                // è®¡ç®—æ–°çš„è·ç¦»å’Œç¼©æ”¾æ¯”ä¾‹
                const newDistance = getDistance(e.touches);
                const newScale = lastScale * (newDistance / lastDistance);
                
                // åªä¿ç•™æœ€å°ç¼©æ”¾é™åˆ¶ï¼Œç§»é™¤æœ€å¤§ç¼©æ”¾é™åˆ¶
                scale = Math.max(0.1, newScale);
                
                // åº”ç”¨ç¼©æ”¾å’Œä½ç§»
                currentImg.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                
                // é˜»æ­¢å›¾ç‰‡æ»‘åŠ¨åˆ‡æ¢
                e.preventDefault();
                return;
            }
            
            // å•æŒ‡æ‹–åŠ¨å¤„ç†
            if (scale > 1) {
                // å½“å›¾ç‰‡è¢«æ”¾å¤§æ—¶ï¼Œæ‹–åŠ¨å›¾ç‰‡è€Œä¸æ˜¯åˆ‡æ¢
                if (e.type === 'touchmove' && e.touches.length === 1) {
                    const touch = e.touches[0];
                    translateX = startTranslateX + touch.clientX - fullscreenStartX;
                    translateY = startTranslateY + touch.clientY - fullscreenStartY;
                } else if (e.type === 'mousemove') {
                    translateX = startTranslateX + e.clientX - fullscreenStartX;
                    translateY = startTranslateY + e.clientY - fullscreenStartY;
                }
                
                // åº”ç”¨ä½ç§»
                currentImg.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                
                // é˜»æ­¢å›¾ç‰‡æ»‘åŠ¨åˆ‡æ¢
                e.preventDefault();
            } else if (!isPinching) {
                // å›¾ç‰‡æœªæ”¾å¤§ä¸”ä¸æ˜¯ä»åŒæŒ‡æ“ä½œåˆ‡æ¢è¿‡æ¥æ—¶ï¼Œæ‰§è¡Œæ­£å¸¸çš„æ»‘åŠ¨åˆ‡æ¢
                const currentPosition = getPositionX(e);
                const diff = currentPosition - fullscreenStartX;
                fullscreenCurrentTranslate = fullscreenPrevTranslate + diff;
                
                // é™åˆ¶æ‹–åŠ¨èŒƒå›´ï¼Œå¢åŠ ä¸€ç‚¹å¼¹æ€§
                if (fullscreenCurrentTranslate > 30) {
                    fullscreenCurrentTranslate = 30;
                } else if (fullscreenCurrentTranslate < -(images.length - 1) * 100 - 30) {
                    fullscreenCurrentTranslate = -(images.length - 1) * 100 - 30;
                }
                
                fullscreenSliderTrack.style.transform = `translateX(${fullscreenCurrentTranslate}%)`;
            }
        }
        
        function fullscreenTouchEnd() {
            if (!fullscreenIsDragging) return;
            
            fullscreenIsDragging = false;
            lastDistance = null;
            
            // åªæœ‰åœ¨å›¾ç‰‡æœªæ”¾å¤§ä¸”ä¸æ˜¯ä»åŒæŒ‡æ“ä½œç»“æŸæ—¶æ‰æ‰§è¡Œæ»‘åŠ¨åˆ‡æ¢
            if (scale <= 1 && !isPinching) {
                // æ ¹æ®æ‹–åŠ¨è·ç¦»å†³å®šæ˜¯åˆ‡æ¢å›¾ç‰‡è¿˜æ˜¯å›åˆ°åŸä½
                const threshold = 20;
                
                // è®¡ç®—ç›¸å¯¹å½“å‰ä½ç½®çš„åç§»ç™¾åˆ†æ¯”
                const relativeTranslate = fullscreenCurrentTranslate - fullscreenPrevTranslate;
                
                if (relativeTranslate > threshold && fullscreenCurrentIndex > 0) {
                    // å‘å³æ‹–åŠ¨è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºä¸Šä¸€å¼ 
                    fullscreenCurrentIndex--;
                    // é‡ç½®å½“å‰å›¾ç‰‡çš„å˜æ¢
                    resetImageTransform();
                } else if (relativeTranslate < -threshold && fullscreenCurrentIndex < images.length - 1) {
                    // å‘å·¦æ‹–åŠ¨è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºä¸‹ä¸€å¼ 
                    fullscreenCurrentIndex++;
                    // é‡ç½®å½“å‰å›¾ç‰‡çš„å˜æ¢
                    resetImageTransform();
                }
                
                // æ›´æ–°ä½ç½®
                const targetPosition = -fullscreenCurrentIndex * 100;
                fullscreenPrevTranslate = targetPosition;
                fullscreenCurrentTranslate = targetPosition;
                
                // åº”ç”¨åŠ¨ç”»
                fullscreenSliderTrack.style.transform = `translateX(${targetPosition}%)`;
            }
            
            // é‡ç½®åŒæŒ‡æ“ä½œæ ‡å¿—
            isPinching = false;
        }
        
        // åˆå§‹åŒ–
        if (albumDropdown.options.length > 1) {
            // å¦‚æœæœ‰ç›¸å†Œï¼Œå¯ä»¥é¢„é€‰ç¬¬ä¸€ä¸ª
            // albumDropdown.selectedIndex = 1;
            // handleAlbumChange();
        }
    </script>
</body>
</html>