<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂõæÁâáÁõ∏ÂÜå - ThreeWeb</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            padding: 15px;
        }
        
        .album-selector {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .album-selector h2 {
            margin-bottom: 10px;
            color: #fff;
            font-size: 18px;
            display: block;
        }
        
        #album-dropdown {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #222;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            display: block;
            margin: 10px auto 0;
            transition: all 0.3s;
        }
        
        #album-dropdown:hover {
            border-color: #3498db;
            background-color: #2a2a2a;
        }
        
        #album-dropdown:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .gallery-container {
            width: 100%;
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }
        
        .gallery-header {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .gallery-header h2 {
            font-size: 20px;
            color: #ddd;
        }
        
        .gallery-stats {
            color: #bbb;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .image-slider {
            position: relative;
            overflow: hidden;
            height: 500px;
            cursor: grab;
        }
        
        .image-slider:active {
            cursor: grabbing;
        }
        
        .slider-track {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .slide {
            flex: 0 0 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
        }
        
        .slide-loading img {
            opacity: 0;
        }
        
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #3498db;
            display: none;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .slide-loading .loading-indicator {
            display: block;
        }
        
        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(52, 58, 64, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
            transition: all 0.3s;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            margin: 0;
        }
        
        .nav-btn:hover {
            background-color: rgba(52, 58, 64, 1);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
        }
        
        .nav-btn:active {
            transform: scale(0.95);
        }
        
        .controls-container {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            width: auto;
            margin-left: auto;
            margin-right: auto;
        }
        
        .pagination {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }
        
        .nav-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
        }
        
        #prev-btn {
            margin-right: 5px;
        }
        
        #next-btn {
            margin-left: 5px;
        }
        
        .image-caption-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .image-caption {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
        
        /* ÁßªÈô§ÊóßÁöÑÂàÜÈ°µÂÆπÂô®Ê†∑ÂºèÔºåÁé∞Âú®‰ΩøÁî®controls-container */
        
        .pagination {
            display: inline-flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            margin: 0 auto;
        }
        
        .pagination-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .pagination-dot:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .pagination-dot.active {
            background-color: #fff;
            border-color: #3498db;
            transform: scale(1.4);
        }
        
        /* ÁßªÈô§ÊóßÁöÑÂõæÁâáÊ†áÈ¢òÊ†∑ÂºèÔºåÁé∞Âú®‰ΩøÁî®Êñ∞ÁöÑÊ†∑ÂºèÂÆπÂô® */
        
        .no-images {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            color: #bbb;
            text-align: center;
            background-color: #111;
            border-radius: 8px;
        }
        
        .no-images i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
        }
        
        .no-images p {
            font-size: 18px;
        }
        
        .back-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: rgba(52, 58, 64, 0.9);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .back-link:hover {
            background-color: rgba(52, 58, 64, 1);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .back-link-container {
            text-align: center;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .gallery-container {
                min-height: 500px;
            }
            
            .image-slider {
                height: 400px;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .navigation {
                padding: 0 10px;
            }
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
</head>
<body>
    <div class="container">
        
        <div class="album-selector">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <h2>üìÇ ÈÄâÊã©Áõ∏ÂÜå</h2>
                <a href="/" class="back-link">
                    <i class="fas fa-arrow-left"></i> ËøîÂõûÈ¶ñÈ°µ
                </a>
            </div>
            <select id="album-dropdown" onchange="handleAlbumChange()" style="width: 100%; font-size: 18px; font-weight: bold;">
                <option value="">-- ËØ∑ÈÄâÊã©‰∏Ä‰∏™Áõ∏ÂÜå --</option>
                {% for album in albums %}
                    <option value="{{ album }}">{{ album }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="gallery-container">
            <div class="gallery-header" style="display: flex; align-items: center; gap: 10px;">
                <h2 id="current-album-name">ËØ∑ÈÄâÊã©‰∏Ä‰∏™Áõ∏ÂÜå</h2>
                <div class="gallery-stats" id="gallery-stats"></div>
            </div>
            
            <!-- Êñá‰ª∂ÂêçÊòæÁ§∫Âå∫Âüü - ÂÆåÂÖ®ÁßªÂá∫ÂõæÁâáÊòæÁ§∫Âå∫Âüü -->
            <div class="image-caption-container" style="display: none;">
                <div class="image-caption" id="current-image-caption"></div>
            </div>
            
            <div id="no-images-message" class="no-images">
                <i class="fas fa-images"></i>
                <p>ËØ∑‰ªé‰∏äÊñπÈÄâÊã©‰∏Ä‰∏™Áõ∏ÂÜåÂºÄÂßãÊµèËßà</p>
            </div>
            
            <div id="image-gallery" style="display: none;">
                <div class="image-slider" id="image-slider">
                    <div class="slider-track" id="slider-track">
                        <!-- ÂõæÁâáÂ∞ÜÂä®ÊÄÅÊèíÂÖ•ËøôÈáå -->
                    </div>
                    
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
                
                <!-- ÂØºËà™ÊåâÈíÆÂíåÂàÜÈ°µÂéüÁÇπÊòæÁ§∫Âå∫Âüü - Âú®Âêå‰∏ÄË°å‰∏îÈÄÇÂΩìÈó¥Ë∑ù -->
                <div style="text-align: center; margin-top: 15px;">
                    <div style="display: inline-flex; align-items: center; gap: 0;">
                        <button class="nav-btn" id="prev-btn" style="margin: 0; width: 40px; height: 40px; font-size: 20px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="pagination" id="pagination" style="display: inline-flex; gap: 10px; margin: 0; padding: 0;"></div>
                        
                        <button class="nav-btn" id="next-btn" style="margin: 0; width: 40px; height: 40px; font-size: 20px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 10px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        
    </div>
    
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentAlbum = null;
        let currentImageIndex = 0;
        let images = [];
        let startX = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let isDragging = false;
        let animationID = 0;
        // ÂèåÂáªÊ£ÄÊµãÂèòÈáè
        let lastTapTime = 0;
        let lastTapTarget = null;
        
        // DOMÂÖÉÁ¥†
        const albumDropdown = document.getElementById('album-dropdown');
        const currentAlbumName = document.getElementById('current-album-name');
        const galleryStats = document.getElementById('gallery-stats');
        const noImagesMessage = document.getElementById('no-images-message');
        const imageGallery = document.getElementById('image-gallery');
        const sliderTrack = document.getElementById('slider-track');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const pagination = document.getElementById('pagination');
        const imageSlider = document.getElementById('image-slider');
        const imageCaptionContainer = document.querySelector('.image-caption-container');
        const currentImageCaption = document.getElementById('current-image-caption');
        
        // ÂÖ®Â±èÈ¢ÑËßàÁõ∏ÂÖ≥ÂÖÉÁ¥†
        let fullscreenViewer;
        let fullscreenSlider;
        let fullscreenSliderTrack;
        let fullscreenCloseBtn;
        let fullscreenCurrentIndex = 0;
        let fullscreenStartX = 0;
        let fullscreenStartY = 0;
        let fullscreenCurrentTranslate = 0;
        let fullscreenPrevTranslate = 0;
        let fullscreenIsDragging = false;
        let fullscreenAnimationID = 0;
        let isPinching = false;
        
        // Áº©ÊîæÁõ∏ÂÖ≥ÂèòÈáè
        let scale = 1;
        let lastDistance = null;
        let lastScale = 1;
        let translateX = 0;
        let translateY = 0;
        let startTranslateX = 0;
        let startTranslateY = 0;
        
        // ‰∫ã‰ª∂ÁõëÂê¨
        albumDropdown.addEventListener('change', handleAlbumChange);
        prevBtn.addEventListener('click', goToPrevSlide);
        nextBtn.addEventListener('click', goToNextSlide);
        
        // Ëß¶Êë∏ÂíåÊãñÊãΩ‰∫ã‰ª∂
        imageSlider.addEventListener('touchstart', touchStart);
        imageSlider.addEventListener('touchend', touchEnd);
        imageSlider.addEventListener('touchmove', touchMove);
        imageSlider.addEventListener('mousedown', touchStart);
        imageSlider.addEventListener('mouseup', touchEnd);
        imageSlider.addEventListener('mouseleave', touchEnd);
        imageSlider.addEventListener('mousemove', touchMove);
        // Ê∑ªÂä†ÂÖ®Â±ÄÈº†Ê†áÈáäÊîæ‰∫ã‰ª∂ÔºåÁ°Æ‰øùÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÈÉΩËÉΩÈáçÁΩÆÊãñÂä®Áä∂ÊÄÅ
        document.addEventListener('mouseup', function(e) {
            if (isDragging && e.target === imageSlider) {
                touchEnd();
            }
        });
        
        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', handleKeydown);
        
        // Â§ÑÁêÜÁõ∏ÂÜåÈÄâÊã©ÂèòÂåñ
        function handleAlbumChange() {
            const albumName = albumDropdown.value;
            if (!albumName) return;
            
            loadAlbum(albumName);
        }
        
        // Âä†ËΩΩÁõ∏ÂÜå
        async function loadAlbum(albumName) {
            try {
                const response = await fetch(`/api/album/${encodeURIComponent(albumName)}`);
                if (!response.ok) {
                    throw new Error('Âä†ËΩΩÁõ∏ÂÜåÂ§±Ë¥•');
                }
                
                const data = await response.json();
                currentAlbum = data.album_name;
                images = data.images;
                currentImageIndex = 0;
                
                updateGalleryUI();
            } catch (error) {
                console.error('Âä†ËΩΩÁõ∏ÂÜåÊó∂Âá∫Èîô:', error);
                alert('Âä†ËΩΩÁõ∏ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Êõ¥Êñ∞Áõ∏ÂÜåUI
        function updateGalleryUI() {
            // Êõ¥Êñ∞Ê†áÈ¢òÂíåÁªüËÆ°‰ø°ÊÅØ
            currentAlbumName.textContent = currentAlbum;
            galleryStats.textContent = images.length > 0 ? `ÂÖ± ${images.length} Âº†ÂõæÁâá` : 'ÊöÇÊó†ÂõæÁâá';
            
            // ÊòæÁ§∫ÊàñÈöêËóèÁõ∏Â∫îÂÖÉÁ¥†
            if (images.length > 0) {
                noImagesMessage.style.display = 'none';
                imageGallery.style.display = 'block';
                imageCaptionContainer.style.display = 'block';
                renderSlides();
                renderPagination();
                updateSlidePosition();
                updatePagination();
                updateImageCaption();
            } else {
                noImagesMessage.style.display = 'flex';
                imageGallery.style.display = 'none';
                imageCaptionContainer.style.display = 'none';
            }
        }
        
        // Ê∏≤ÊüìÂπªÁÅØÁâá
        function renderSlides() {
            sliderTrack.innerHTML = '';
            
            images.forEach((image, index) => {
                const slide = document.createElement('div');
                slide.classList.add('slide');
                slide.dataset.index = index;
                
                const img = document.createElement('img');
                img.src = image.path;
                img.alt = image.name;
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Ôºå‰ΩøÁî®Ëá™ÂÆö‰πâÂèåÂáªÊ£ÄÊµã
                img.addEventListener('click', function() {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTapTime;
                    
                    // Ê£ÄÊµãÊòØÂê¶‰∏∫ÂèåÂáªÔºöÊó∂Èó¥Èó¥ÈöîÂ∞è‰∫é300ms‰∏îÊòØÂêå‰∏ÄÁõÆÊ†á
                    if (tapLength < 300 && tapLength > 0 && lastTapTarget === this) {
                        openFullscreenViewer(index);
                        // ÈáçÁΩÆÂèåÂáªÁä∂ÊÄÅ
                        lastTapTime = 0;
                        lastTapTarget = null;
                    } else {
                        // ËÆ∞ÂΩïÂçïÂáª‰ø°ÊÅØ
                        lastTapTime = currentTime;
                        lastTapTarget = this;
                        
                        // ËÆæÁΩÆ300msÂêéÊ∏ÖÈô§ÔºåÈÅøÂÖçËøûÁª≠ÁÇπÂáªË¢´ËØØÂà§
                        setTimeout(() => {
                            lastTapTarget = null;
                        }, 300);
                    }
                });
                
                // Ê∑ªÂä†Âä†ËΩΩÊåáÁ§∫Âô®
                const loadingIndicator = document.createElement('div');
                loadingIndicator.classList.add('loading-indicator');
                loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i><div style="margin-top: 10px; font-size: 14px; color: #bbb;">Âä†ËΩΩ‰∏≠...</div>';
                
                // ÂõæÁâáÂä†ËΩΩÂ§ÑÁêÜ
                slide.classList.add('slide-loading');
                img.onload = () => {
                    slide.classList.remove('slide-loading');
                };
                
                slide.appendChild(img);
                slide.appendChild(loadingIndicator);
                sliderTrack.appendChild(slide);
            });
            
            // Êõ¥Êñ∞ÂΩìÂâçÂõæÁâáÊ†áÈ¢ò
            if (images.length > 0) {
                updateImageCaption();
            }
        }
        
        // Ê∏≤ÊüìÂàÜÈ°µÊåáÁ§∫Âô® - ‰øÆÊîπ‰∏∫1/nÊòæÁ§∫ÂΩ¢Âºè
        function renderPagination() {
            pagination.innerHTML = '';
            
            // ÂàõÂª∫È°µÁ†ÅÊñáÊú¨ÂÖÉÁ¥†
            const pageInfo = document.createElement('div');
            pageInfo.classList.add('page-info');
            pageInfo.style.color = '#fff';
            pageInfo.style.fontSize = '16px';
            pageInfo.style.fontWeight = 'bold';
            pageInfo.style.minWidth = '60px';
            pageInfo.style.textAlign = 'center';
            
            pagination.appendChild(pageInfo);
        }
        
        // Êõ¥Êñ∞ÂàÜÈ°µÊåáÁ§∫Âô®
        function updatePagination() {
            const pageInfo = pagination.querySelector('.page-info');
            if (pageInfo && images.length > 0) {
                // ÊòæÁ§∫ 1/n Ê†ºÂºèÔºåÂΩìÂâçÈ°µÁ†Å‰ªé1ÂºÄÂßãËÆ°Êï∞
                pageInfo.textContent = `${currentImageIndex + 1}/${images.length}`;
            }
        }
        
        // Êõ¥Êñ∞ÂõæÁâáÊ†áÈ¢ò
        function updateImageCaption() {
            if (images.length > 0 && currentImageIndex < images.length) {
                currentImageCaption.textContent = images[currentImageIndex].name;
                imageCaptionContainer.style.display = 'block';
            } else {
                imageCaptionContainer.style.display = 'none';
            }
        }
        
        // Êõ¥Êñ∞ÂπªÁÅØÁâá‰ΩçÁΩÆ
        function updateSlidePosition() {
            const slideWidth = -currentImageIndex * 100;
            sliderTrack.style.transform = `translateX(${slideWidth}%)`;
            updatePagination();
        }
        
        // ‰∏ä‰∏ÄÂº†
        function goToPrevSlide() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateSlidePosition();
                updatePagination();
                updateImageCaption();
            }
        }
        
        // ‰∏ã‰∏ÄÂº†
        function goToNextSlide() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateSlidePosition();
                updatePagination();
                updateImageCaption();
            }
        }
        
        // ÂÖ®Â±ÄÂèòÈáè - Ê∑ªÂä†ÁßªÂä®Ë∑ùÁ¶ªËÆ∞ÂΩï
        let totalMoveDistance = 0;
        
        // Ëß¶Êë∏/Èº†Ê†áÂºÄÂßã
        function touchStart(e) {
            startX = getPositionX(e);
            isDragging = true;
            totalMoveDistance = 0;
            
            // ÂèñÊ∂àÊ≠£Âú®ËøõË°åÁöÑÂä®Áîª
            cancelAnimationFrame(animationID);
            
            // ÂØπ‰∫éÈº†Ê†á‰∫ã‰ª∂ÔºåÈòªÊ≠¢ÊñáÊú¨ÈÄâÊã©Á≠âÈªòËÆ§Ë°å‰∏∫
            if (e.type.includes('mouse')) {
                e.preventDefault();
            }
            // Ê≥®ÊÑèÔºöÂú®touchstart‰∏≠‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Ôºå‰ª•ÂÖÅËÆ∏ÁÇπÂáª‰∫ã‰ª∂Ê≠£Â∏∏Ëß¶Âèë
        }
        
        // Ëß¶Êë∏/Èº†Ê†áÁßªÂä®
        function touchMove(e) {
            if (!isDragging) return;
            
            const currentPosition = getPositionX(e);
            const diff = currentPosition - startX;
            totalMoveDistance = Math.abs(diff); // ËÆ∞ÂΩïÁßªÂä®ÊÄªË∑ùÁ¶ª
            currentTranslate = prevTranslate + diff;
            
            // Âè™ÊúâÂú®ÊúâÊòéÊòæÁßªÂä®Êó∂ÊâçÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºåÈÅøÂÖçÂπ≤Êâ∞ÁÇπÂáª‰∫ã‰ª∂
            if (totalMoveDistance > 5) {
                e.preventDefault();
            }
            
            // ÈôêÂà∂ÊãñÂä®ËåÉÂõ¥ÔºåÂ¢ûÂä†‰∏ÄÁÇπÂºπÊÄß
            if (currentTranslate > 30) {
                currentTranslate = 30;
            } else if (currentTranslate < -(images.length - 1) * 100 - 30) {
                currentTranslate = -(images.length - 1) * 100 - 30;
            }
            
            setSliderPosition();
        }
        
        // Ëß¶Êë∏/Èº†Ê†áÁªìÊùü
        function touchEnd() {
            if (!isDragging) return;
            
            isDragging = false;
            
            // Ê†πÊçÆÊãñÂä®Ë∑ùÁ¶ªÂÜ≥ÂÆöÊòØÂàáÊç¢ÂõæÁâáËøòÊòØÂõûÂà∞Âéü‰Ωç
            const threshold = 20; // ÂáèÂ∞èÈòàÂÄºÔºåËÆ©Áî®Êà∑Âè™ÈúÄËΩªËΩªÊªëÂä®
            const minMovement = 5; // ÊúÄÂ∞èÁßªÂä®Ë∑ùÁ¶ªÔºåÈÅøÂÖçÁ∫ØÁÇπÂáªË¢´ËØØÂà§‰∏∫ÊªëÂä®
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁöÑÁßªÂä®Ë∑ùÁ¶ªÔºåÈÅøÂÖçÁ∫ØÁÇπÂáªËß¶ÂèëÂàáÊç¢
            if (totalMoveDistance >= minMovement) {
                // ËÆ°ÁÆóÁõ∏ÂØπÂΩìÂâç‰ΩçÁΩÆÁöÑÂÅèÁßªÁôæÂàÜÊØî
                const relativeTranslate = currentTranslate - prevTranslate;
                
                if (relativeTranslate > threshold && currentImageIndex > 0) {
                    // ÂêëÂè≥ÊãñÂä®Ë∂ÖËøáÈòàÂÄºÔºåÊòæÁ§∫‰∏ä‰∏ÄÂº†
                    currentImageIndex--;
                } else if (relativeTranslate < -threshold && currentImageIndex < images.length - 1) {
                    // ÂêëÂ∑¶ÊãñÂä®Ë∂ÖËøáÈòàÂÄºÔºåÊòæÁ§∫‰∏ã‰∏ÄÂº†
                    currentImageIndex++;
                }
            }
            
            // Â∫îÁî®ÊÉØÊÄßÂä®Áîª
            applyInertia();
            
            // Á°Æ‰øù‰ΩçÁΩÆÊ≠£Á°ÆÊõ¥Êñ∞
            const targetPosition = -currentImageIndex * 100;
            prevTranslate = targetPosition;
            currentTranslate = targetPosition;
            
            updatePagination();
            updateImageCaption();
        }
        
        // ËÆæÁΩÆÊªëÂùó‰ΩçÁΩÆ
        function setSliderPosition() {
            sliderTrack.style.transform = `translateX(${currentTranslate}%)`;
        }
        
        // Â∫îÁî®ÊÉØÊÄßÂä®Áîª
        function applyInertia() {
            const targetPosition = -currentImageIndex * 100;
            const duration = 300; // Âä®ÁîªÊåÅÁª≠Êó∂Èó¥
            const startTime = performance.now();
            const startPosition = currentTranslate;
            const distance = targetPosition - startPosition;
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ‰ΩøÁî®ÁºìÂä®ÂáΩÊï∞
                const easeOut = 1 - Math.pow(1 - progress, 3);
                currentTranslate = startPosition + distance * easeOut;
                
                setSliderPosition();
                
                if (progress < 1) {
                    animationID = requestAnimationFrame(animate);
                } else {
                    currentTranslate = targetPosition;
                    setSliderPosition();
                    prevTranslate = currentTranslate;
                }
            }
            
            animationID = requestAnimationFrame(animate);
        }
        
        // Ëé∑ÂèñËß¶Êë∏/Èº†Ê†á‰ΩçÁΩÆ
        function getPositionX(e) {
            return e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        }
        
        function getPositionY(e) {
            return e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        }
        
        // ‰øùÂ≠òYËΩ¥Ëµ∑Âßã‰ΩçÁΩÆÂ∑≤Âú®ÂÖ®Â±ÄÂèòÈáè‰∏≠Â£∞Êòé
        
        // ‰øÆÊîπgetPositionXÂáΩÊï∞Ë∞ÉÁî®Â§ÑÔºåÂêåÊó∂‰øùÂ≠òYËΩ¥‰ΩçÁΩÆ
        const originalTouchStart = fullscreenTouchStart;
        fullscreenTouchStart = function(e) {
            fullscreenStartY = getPositionY(e);
            originalTouchStart(e);
        };
        
        // ÈîÆÁõòÂØºËà™
        function handleKeydown(e) {
            if (images.length === 0) return;
            
            // Â¶ÇÊûúÂÖ®Â±èÈ¢ÑËßàÊâìÂºÄÔºåÂàôÊéßÂà∂ÂÖ®Â±èÈ¢ÑËßà
            if (document.fullscreenElement || fullscreenViewer && fullscreenViewer.style.display === 'flex') {
                switch (e.key) {
                    case 'ArrowLeft':
                        fullscreenGoToPrevSlide();
                        break;
                    case 'ArrowRight':
                        fullscreenGoToNextSlide();
                        break;
                    case 'Escape':
                        closeFullscreenViewer();
                        break;
                }
            } else {
                // Âê¶ÂàôÊéßÂà∂ÊôÆÈÄöËßÜÂõæ
                switch (e.key) {
                    case 'ArrowLeft':
                        goToPrevSlide();
                        break;
                    case 'ArrowRight':
                        goToNextSlide();
                        break;
                }
            }
        }
        
        // ===== ÂÖ®Â±èÈ¢ÑËßàÂäüËÉΩ =====
        function openFullscreenViewer(index) {
            // ÂàùÂßãÂåñÂÖ®Â±èÊü•ÁúãÂô®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (!fullscreenViewer) {
                createFullscreenViewer();
            }
            
            // ËÆæÁΩÆÂΩìÂâçÁ¥¢Âºï
            fullscreenCurrentIndex = index;
            fullscreenPrevTranslate = -fullscreenCurrentIndex * 100;
            fullscreenCurrentTranslate = fullscreenPrevTranslate;
            
            // Ê∏≤ÊüìÂÖ®Â±èÂπªÁÅØÁâá
            renderFullscreenSlides();
            
            // ÊòæÁ§∫ÂÖ®Â±èÊü•ÁúãÂô®
            fullscreenViewer.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Èò≤Ê≠¢ËÉåÊôØÊªöÂä®
            
            // Â∞ùËØïËøõÂÖ•ÂÖ®Â±èÊ®°Âºè
            if (fullscreenViewer.requestFullscreen) {
                fullscreenViewer.requestFullscreen();
            }
        }
        
        function closeFullscreenViewer() {
            // ÈÄÄÂá∫ÂÖ®Â±èÊ®°Âºè
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
            
            // ÈöêËóèÂÖ®Â±èÊü•ÁúãÂô®
            if (fullscreenViewer) {
                fullscreenViewer.style.display = 'none';
            }
            document.body.style.overflow = 'auto'; // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
        }
        
        function createFullscreenViewer() {
            // ÂàõÂª∫ÂÖ®Â±èÊü•ÁúãÂô®ÂÆπÂô®
            fullscreenViewer = document.createElement('div');
            fullscreenViewer.id = 'fullscreen-viewer';
            fullscreenViewer.style.cssText = `
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.95);
                z-index: 1000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            `;
            
            // ÂàõÂª∫ÂÖ≥Èó≠ÊåâÈíÆ
            fullscreenCloseBtn = document.createElement('button');
            fullscreenCloseBtn.id = 'fullscreen-close-btn';
            fullscreenCloseBtn.innerHTML = '<i class="fas fa-times"></i>';
            fullscreenCloseBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 20px;
                cursor: pointer;
                z-index: 1001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            fullscreenCloseBtn.addEventListener('click', closeFullscreenViewer);
            
            // ÂàõÂª∫ÂÖ®Â±èÊªëÂùóÂÆπÂô®
            fullscreenSlider = document.createElement('div');
            fullscreenSlider.id = 'fullscreen-slider';
            fullscreenSlider.style.cssText = `
                width: 100%;
                height: 100%;
                overflow: hidden;
                position: relative;
            `;
            
            // ÂàõÂª∫ÂÖ®Â±èÊªëÂùóËΩ®ÈÅì
            fullscreenSliderTrack = document.createElement('div');
            fullscreenSliderTrack.id = 'fullscreen-slider-track';
            fullscreenSliderTrack.style.cssText = `
                display: flex;
                transition: transform 0.3s ease;
                height: 100%;
            `;
            
            // ÁªÑË£ÖÂÖÉÁ¥†
            fullscreenSlider.appendChild(fullscreenSliderTrack);
            fullscreenViewer.appendChild(fullscreenCloseBtn);
            fullscreenViewer.appendChild(fullscreenSlider);
            
            // Ê∑ªÂä†Âà∞ÊñáÊ°£
            document.body.appendChild(fullscreenViewer);
            
            // Ê∑ªÂä†Ëß¶Êë∏ÂíåÈº†Ê†á‰∫ã‰ª∂
            fullscreenSlider.addEventListener('touchstart', fullscreenTouchStart);
            fullscreenSlider.addEventListener('touchend', fullscreenTouchEnd);
            fullscreenSlider.addEventListener('touchmove', fullscreenTouchMove);
            fullscreenSlider.addEventListener('mousedown', fullscreenTouchStart);
            fullscreenSlider.addEventListener('mouseup', fullscreenTouchEnd);
            fullscreenSlider.addEventListener('mouseleave', fullscreenTouchEnd);
            fullscreenSlider.addEventListener('mousemove', fullscreenTouchMove);
            
            // Ê∑ªÂä†ÂÖ®Â±ÄÈáçÁΩÆÁº©Êîæ‰∫ã‰ª∂
            fullscreenCloseBtn.addEventListener('click', function() {
                // ÈáçÁΩÆÁº©ÊîæÂíå‰ΩçÁßª
                resetImageTransforms();
                closeFullscreenViewer();
            });
            
            // Ê∑ªÂä†ÁÇπÂáªÂàáÊç¢‰∫ã‰ª∂ÔºàÁÇπÂáªÂ∑¶Âè≥ÂçäÈÉ®ÂàÜÔºâ
            fullscreenSlider.addEventListener('click', function(e) {
                if (!fullscreenIsDragging && e.target === fullscreenSlider) {
                    const rect = fullscreenSlider.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const clickX = e.clientX - rect.left;
                    
                    if (clickX < centerX) {
                        fullscreenGoToPrevSlide();
                    } else {
                        fullscreenGoToNextSlide();
                    }
                }
            });
            
            // ÁõëÂê¨ÂÖ®Â±èÂèòÂåñ‰∫ã‰ª∂
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement && fullscreenViewer && fullscreenViewer.style.display === 'flex') {
                    closeFullscreenViewer();
                }
            });
        }
        
        function renderFullscreenSlides() {
            fullscreenSliderTrack.innerHTML = '';
            
            images.forEach((image, index) => {
                const slide = document.createElement('div');
                slide.classList.add('fullscreen-slide');
                slide.dataset.index = index;
                slide.style.cssText = `
                    min-width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                `;
                
                const img = document.createElement('img');
                img.src = image.path;
                img.alt = image.name;
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    transform-origin: center;
                    transition: transform 0.2s ease;
                    cursor: grab;
                `;
                
                // ‰∏∫ÂõæÁâáÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÂèåÂáªÈáçÁΩÆÁº©Êîæ
                img.addEventListener('dblclick', function() {
                    resetImageTransform(this);
                });
                
                // Ê∑ªÂä†ÂõæÁâáÊ†áÈ¢ò
                const caption = document.createElement('div');
                caption.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    left: 0;
                    right: 0;
                    text-align: center;
                    color: white;
                    font-size: 16px;
                    background-color: rgba(0, 0, 0, 0.7);
                    padding: 10px;
                    margin: 0 20px;
                    border-radius: 5px;
                `;
                caption.textContent = image.name;
                
                slide.appendChild(img);
                slide.appendChild(caption);
                fullscreenSliderTrack.appendChild(slide);
            });
            
            // Êõ¥Êñ∞ÊªëÂùó‰ΩçÁΩÆ
            updateFullscreenSlidePosition();
        }
        
        function updateFullscreenSlidePosition() {
            const slideWidth = -fullscreenCurrentIndex * 100;
            fullscreenSliderTrack.style.transform = `translateX(${slideWidth}%)`;
        }
        
        function fullscreenGoToPrevSlide() {
            if (fullscreenCurrentIndex > 0) {
                fullscreenCurrentIndex--;
                // ÈáçÁΩÆÂΩìÂâçÂõæÁâáÁöÑÂèòÊç¢
                resetImageTransform();
                updateFullscreenSlidePosition();
            }
        }
        
        function fullscreenGoToNextSlide() {
            if (fullscreenCurrentIndex < images.length - 1) {
                fullscreenCurrentIndex++;
                // ÈáçÁΩÆÂΩìÂâçÂõæÁâáÁöÑÂèòÊç¢
                resetImageTransform();
                updateFullscreenSlidePosition();
            }
        }
        
        // ËÆ°ÁÆó‰∏§ÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ª
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // ÈáçÁΩÆÂçï‰∏™ÂõæÁâáÁöÑÂèòÊç¢
        function resetImageTransform(img) {
            scale = 1;
            translateX = 0;
            translateY = 0;
            startTranslateX = 0;
            startTranslateY = 0;
            lastDistance = null;
            lastScale = 1;
            isPinching = false;
            
            if (img) {
                img.style.transform = 'scale(1) translate(0, 0)';
            }
        }
        
        // ÈáçÁΩÆÊâÄÊúâÂõæÁâáÁöÑÂèòÊç¢
        function resetImageTransforms() {
            const slides = fullscreenSliderTrack.querySelectorAll('.fullscreen-slide img');
            slides.forEach(img => {
                resetImageTransform(img);
            });
        }
        
        function fullscreenTouchStart(e) {
            fullscreenStartX = getPositionX(e);
            fullscreenStartY = getPositionY(e);
            fullscreenIsDragging = true;
            isPinching = false;
            
            // ‰øùÂ≠òÂΩìÂâçÁöÑ‰ΩçÁßªÁä∂ÊÄÅ
            startTranslateX = translateX;
            startTranslateY = translateY;
            
            // Â§ÑÁêÜÂèåÊåáËß¶Êë∏ÂºÄÂßã
            if (e.type === 'touchstart' && e.touches.length === 2) {
                lastDistance = getDistance(e.touches);
                lastScale = scale;
                isPinching = true;
                // ÂèåÊåáÊìç‰ΩúÊó∂Ôºå‰∏çËøõË°åÂõæÁâáÂàáÊç¢ÁöÑÂàùÂßãÂåñ
            }
            
            // ÂèñÊ∂àÊ≠£Âú®ËøõË°åÁöÑÂä®Áîª
            cancelAnimationFrame(fullscreenAnimationID);
            
            // Ê≥®ÊÑèÔºöÂú®touchstart‰∏≠‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Ôºå‰ª•ÂÖÅËÆ∏ÁÇπÂáª‰∫ã‰ª∂Ê≠£Â∏∏Ëß¶Âèë
            // ÂØπ‰∫éÈº†Ê†á‰∫ã‰ª∂ÔºåÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            if (e.type.includes('mouse')) {
                e.preventDefault();
            }
        }
        
        function fullscreenTouchMove(e) {
            if (!fullscreenIsDragging) return;
            
            // Ëé∑ÂèñÂΩìÂâçÊ¥ªÂä®ÁöÑÂõæÁâá
            const currentSlide = fullscreenSliderTrack.querySelector(`.fullscreen-slide[data-index="${fullscreenCurrentIndex}"]`);
            if (!currentSlide) return;
            
            const currentImg = currentSlide.querySelector('img');
            if (!currentImg) return;
            
            // ËÆ°ÁÆóÁßªÂä®Ë∑ùÁ¶ª
            const currentX = getPositionX(e);
            const currentY = getPositionY(e);
            const diffX = currentX - fullscreenStartX;
            const diffY = currentY - fullscreenStartY;
            
            // Âè™ÊúâÂú®ÊúâÊòéÊòæÁßªÂä®Êó∂ÊâçÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            if (Math.abs(diffX) > 5 || Math.abs(diffY) > 5) {
                e.preventDefault();
            }
            
            // Â§ÑÁêÜÂèåÊåáÁº©Êîæ - Êõ¥È´ò‰ºòÂÖàÁ∫ß
            if (e.type === 'touchmove' && e.touches.length === 2) {
                isPinching = true;
                
                // ËÆ°ÁÆóÊñ∞ÁöÑË∑ùÁ¶ªÂíåÁº©ÊîæÊØî‰æã
                const newDistance = getDistance(e.touches);
                const newScale = lastScale * (newDistance / lastDistance);
                
                // Âè™‰øùÁïôÊúÄÂ∞èÁº©ÊîæÈôêÂà∂ÔºåÁßªÈô§ÊúÄÂ§ßÁº©ÊîæÈôêÂà∂
                scale = Math.max(0.1, newScale);
                
                // Â∫îÁî®Áº©ÊîæÂíå‰ΩçÁßª
                currentImg.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                
                // ÈòªÊ≠¢ÂõæÁâáÊªëÂä®ÂàáÊç¢
                e.preventDefault();
                return;
            }
            
            // ÂçïÊåáÊãñÂä®Â§ÑÁêÜ
            if (scale > 1) {
                // ÂΩìÂõæÁâáË¢´ÊîæÂ§ßÊó∂ÔºåÊãñÂä®ÂõæÁâáËÄå‰∏çÊòØÂàáÊç¢
                if (e.type === 'touchmove' && e.touches.length === 1) {
                    const touch = e.touches[0];
                    translateX = startTranslateX + touch.clientX - fullscreenStartX;
                    translateY = startTranslateY + touch.clientY - fullscreenStartY;
                } else if (e.type === 'mousemove') {
                    translateX = startTranslateX + e.clientX - fullscreenStartX;
                    translateY = startTranslateY + e.clientY - fullscreenStartY;
                }
                
                // Â∫îÁî®‰ΩçÁßª
                currentImg.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                
                // ÈòªÊ≠¢ÂõæÁâáÊªëÂä®ÂàáÊç¢
                e.preventDefault();
            } else if (!isPinching) {
                // ÂõæÁâáÊú™ÊîæÂ§ß‰∏î‰∏çÊòØ‰ªéÂèåÊåáÊìç‰ΩúÂàáÊç¢ËøáÊù•Êó∂ÔºåÊâßË°åÊ≠£Â∏∏ÁöÑÊªëÂä®ÂàáÊç¢
                const currentPosition = getPositionX(e);
                const diff = currentPosition - fullscreenStartX;
                fullscreenCurrentTranslate = fullscreenPrevTranslate + diff;
                
                // ÈôêÂà∂ÊãñÂä®ËåÉÂõ¥ÔºåÂ¢ûÂä†‰∏ÄÁÇπÂºπÊÄß
                if (fullscreenCurrentTranslate > 30) {
                    fullscreenCurrentTranslate = 30;
                } else if (fullscreenCurrentTranslate < -(images.length - 1) * 100 - 30) {
                    fullscreenCurrentTranslate = -(images.length - 1) * 100 - 30;
                }
                
                fullscreenSliderTrack.style.transform = `translateX(${fullscreenCurrentTranslate}%)`;
            }
        }
        
        function fullscreenTouchEnd() {
            if (!fullscreenIsDragging) return;
            
            fullscreenIsDragging = false;
            lastDistance = null;
            
            // Âè™ÊúâÂú®ÂõæÁâáÊú™ÊîæÂ§ß‰∏î‰∏çÊòØ‰ªéÂèåÊåáÊìç‰ΩúÁªìÊùüÊó∂ÊâçÊâßË°åÊªëÂä®ÂàáÊç¢
            if (scale <= 1 && !isPinching) {
                // Ê†πÊçÆÊãñÂä®Ë∑ùÁ¶ªÂÜ≥ÂÆöÊòØÂàáÊç¢ÂõæÁâáËøòÊòØÂõûÂà∞Âéü‰Ωç
                const threshold = 20;
                
                // ËÆ°ÁÆóÁõ∏ÂØπÂΩìÂâç‰ΩçÁΩÆÁöÑÂÅèÁßªÁôæÂàÜÊØî
                const relativeTranslate = fullscreenCurrentTranslate - fullscreenPrevTranslate;
                
                if (relativeTranslate > threshold && fullscreenCurrentIndex > 0) {
                    // ÂêëÂè≥ÊãñÂä®Ë∂ÖËøáÈòàÂÄºÔºåÊòæÁ§∫‰∏ä‰∏ÄÂº†
                    fullscreenCurrentIndex--;
                    // ÈáçÁΩÆÂΩìÂâçÂõæÁâáÁöÑÂèòÊç¢
                    resetImageTransform();
                } else if (relativeTranslate < -threshold && fullscreenCurrentIndex < images.length - 1) {
                    // ÂêëÂ∑¶ÊãñÂä®Ë∂ÖËøáÈòàÂÄºÔºåÊòæÁ§∫‰∏ã‰∏ÄÂº†
                    fullscreenCurrentIndex++;
                    // ÈáçÁΩÆÂΩìÂâçÂõæÁâáÁöÑÂèòÊç¢
                    resetImageTransform();
                }
                
                // Êõ¥Êñ∞‰ΩçÁΩÆ
                const targetPosition = -fullscreenCurrentIndex * 100;
                fullscreenPrevTranslate = targetPosition;
                fullscreenCurrentTranslate = targetPosition;
                
                // Â∫îÁî®Âä®Áîª
                fullscreenSliderTrack.style.transform = `translateX(${targetPosition}%)`;
            }
            
            // ÈáçÁΩÆÂèåÊåáÊìç‰ΩúÊ†áÂøó
            isPinching = false;
        }
        
        // ÂàùÂßãÂåñ
        if (albumDropdown.options.length > 1) {
            // Â¶ÇÊûúÊúâÁõ∏ÂÜåÔºåÂèØ‰ª•È¢ÑÈÄâÁ¨¨‰∏Ä‰∏™
            // albumDropdown.selectedIndex = 1;
            // handleAlbumChange();
        }
    </script>
</body>
</html>